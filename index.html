<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Service Job Estimator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-field {
            @apply p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 w-full;
        }
        .btn-primary {
            @apply p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md;
        }
        .btn-secondary {
            @apply p-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 shadow-md;
        }
        .scrollable-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">HVAC Job Cost Calculator</h1>
            <p class="text-gray-500 mt-1">Create professional, margin-controlled service estimates quickly.</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex items-center justify-center p-8 bg-white shadow-lg rounded-xl mb-6 hidden">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-blue-600 font-medium">Initializing database and loading data...</span>
        </div>

        <!-- System Message Box -->
        <div id="message-box" class="hidden p-4 rounded-lg text-sm mb-6 transition-opacity duration-300" role="alert"></div>

        <!-- Inventory and Customer Info Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
            <!-- Customer Information Section -->
            <section class="bg-white p-6 rounded-xl shadow-lg xl:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Customer & Job Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="customer-name" placeholder="Customer Name" class="input-field">
                    <input type="text" id="customer-address" placeholder="Job Address" class="input-field">
                    <input type="tel" id="customer-phone" placeholder="Phone Number" class="input-field">
                    <input type="email" id="customer-email" placeholder="Email Address (Optional)" class="input-field">
                </div>
            </section>

            <!-- Part Inventory Management Section (UPDATED) -->
            <section class="bg-white p-6 rounded-xl shadow-lg xl:col-span-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Part & Service Inventory</h2>

                <div class="space-y-3 p-3 bg-blue-50 rounded-lg">
                    <h3 class="text-sm font-bold text-blue-700">Add New Item</h3>
                    
                    <!-- Category Selector -->
                    <select id="part-category-select" class="input-field p-2 text-sm" onchange="checkNewCategory(this.value)">
                        <option value="" disabled selected>-- Select/Enter Category --</option>
                        <!-- Options filled by JS -->
                    </select>
                    <input type="text" id="new-category-input" placeholder="New Category Name (e.g., Plumbing)" class="input-field p-2 text-sm hidden">

                    <input type="text" id="part-name" placeholder="Item Name (e.g., Motor Replacement)" class="input-field p-2 text-sm">
                    <input type="text" id="part-number" placeholder="Part Number (Optional)" class="input-field p-2 text-sm">
                    <input type="text" id="part-brand" placeholder="Brand (Optional)" class="input-field p-2 text-sm">
                    <input type="number" id="part-cost" min="0" step="0.01" placeholder="Cost to Business ($)" class="input-field p-2 text-sm">
                    <button onclick="saveInventoryPart()" class="w-full p-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition duration-150">
                        + Save New Item to Inventory
                    </button>
                </div>
                
                <h3 class="text-md font-medium text-gray-700 mt-4 mb-2 border-b pb-1">Filter Inventory List</h3>
                <div class="space-y-2 mb-4">
                    <select id="filter-category" class="input-field p-2 text-sm" onchange="renderInventory()">
                        <option value="">All Categories</option>
                        <!-- Options filled by JS -->
                    </select>
                    <input type="text" id="filter-name" placeholder="Filter by Name/Part No./Brand" class="input-field p-2 text-sm" oninput="renderInventory()">
                </div>

                <div id="inventory-list" class="scrollable-list bg-gray-50 p-2 text-xs">
                    <p class="text-gray-400 text-center py-4">Loading parts...</p>
                    <!-- Inventory parts will be loaded here -->
                </div>
            </section>
        </div>

        <!-- Line Items Section -->
        <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Job Line Items (Cost to Business)</h2>

            <!-- Quick Add Service Selector (NEW) -->
            <div class="mb-4 flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <label for="inventory-selector" class="whitespace-nowrap font-medium text-gray-700">Quick Add:</label>
                <select id="inventory-selector" onchange="selectPartForJob(this.value)" class="input-field p-2 text-sm flex-grow">
                    <option value="" disabled selected>-- Select a Part or Service from Inventory --</option>
                    <!-- Inventory parts will be loaded here -->
                </select>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">
                            <th class="px-3 py-3 text-left">Description</th>
                            <th class="px-3 py-3 text-right">Cost ($)</th>
                            <th class="px-3 py-3 text-right">Qty</th>
                            <th class="px-3 py-3 text-right">Item Cost</th>
                            <th class="px-3 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="line-items-body" class="bg-white divide-y divide-gray-200">
                        <!-- Line items will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <button onclick="addLineItem()" class="mt-4 w-full md:w-auto px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 shadow-md">
                + Add Ad-hoc Item
            </button>
        </section>

        <!-- Summary & Margin Adjustment Section -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Totals Card -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Summary</h2>

                <div class="space-y-3">
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-gray-600">Total Material & Labor Cost:</span>
                        <span id="subtotal" class="font-bold text-gray-800">$0.00</span>
                    </div>

                    <div class="flex justify-between items-center border-t pt-3">
                        <label for="profit-margin" class="text-gray-600 flex items-center">
                            <span>Target Profit Margin:</span>
                            <input type="number" id="profit-margin" value="25" min="0" max="100" class="w-16 ml-3 text-right border rounded-lg px-2 py-1 focus:ring-blue-500 focus:border-blue-500" oninput="recalculateTotals()">
                            <span class="ml-1 text-xl font-bold text-blue-600">%</span>
                        </label>
                        <span id="margin-amount" class="font-bold text-blue-600">$0.00</span>
                    </div>

                    <div class="flex justify-between items-center text-2xl font-extrabold text-green-700 border-t-4 border-double border-green-200 pt-4">
                        <span>Customer Final Price:</span>
                        <span id="grand-total">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg flex flex-col space-y-4">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Actions</h2>
                <button onclick="saveEstimate()" class="btn-primary">
                    ðŸ’¾ Save Estimate to Database
                </button>
                <button onclick="generateEstimateText()" class="btn-secondary">
                    ðŸ“§ Generate Email/Copy Text
                </button>
                <div id="user-id-display" class="text-xs text-gray-400 mt-4 break-words">User ID: N/A</div>
            </div>
        </section>

    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Use the global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        // Global data stores
        window.lineItems = [];
        window.inventory = [];
        window.categories = []; // New array for categories
        let itemIdCounter = 1;

        // Set Firestore log level for debugging
        setLogLevel('Debug');

        // Initial setup function
        const initializeFirebase = async () => {
            document.getElementById('loading-indicator').classList.remove('hidden');

            if (!firebaseConfig) {
                console.error("Firebase config not found.");
                showMessage("Database setup failed. Cannot connect to persistent storage.", 'bg-red-100 text-red-700');
                document.getElementById('loading-indicator').classList.add('hidden');
                return;
            }

            try {
                // 1. Initialize Firebase App
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 2. Handle Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        showMessage("Database connection secured.", 'bg-green-100 text-green-700');
                        // Start fetching data once authenticated
                        fetchCategories(); // Fetch categories first
                        fetchInventory(); // Fetch inventory
                        addDefaultServiceItems(); // Ensure default items exist
                    } else {
                        userId = null;
                        document.getElementById('user-id-display').textContent = 'User ID: N/A (Signed Out)';
                        isAuthReady = true;
                    }
                    document.getElementById('loading-indicator').classList.add('hidden');
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                showMessage(`Error initializing database: ${error.message}`, 'bg-red-100 text-red-700');
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        };

        // --- Utility Functions ---

        window.showMessage = (message, className) => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `${className} p-4 rounded-lg text-sm mb-6 transition-opacity duration-300`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        };

        window.formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        };

        window.debounce = (func, delay) => {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        // --- Category Management ---

        const fetchCategories = () => {
            if (!isAuthReady || !userId) return;

            const categoryRef = collection(db, `/artifacts/${appId}/users/${userId}/hvac_categories`);

            onSnapshot(categoryRef, (snapshot) => {
                window.categories = [];
                snapshot.forEach(doc => {
                    window.categories.push({ id: doc.id, ...doc.data() });
                });
                renderCategorySelectors();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showMessage("Could not load categories.", 'bg-red-100 text-red-700');
            });
        };
        
        const renderCategorySelectors = () => {
            const addSelector = document.getElementById('part-category-select');
            const filterSelector = document.getElementById('filter-category');

            // Clear and reset Add selector
            addSelector.innerHTML = '<option value="" disabled selected>-- Select/Enter Category --</option>';
            window.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                addSelector.appendChild(option);
            });
            addSelector.innerHTML += '<option value="__NEW__">-- Add New Category --</option>';

            // Clear and reset Filter selector
            filterSelector.innerHTML = '<option value="">All Categories</option>';
            window.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                filterSelector.appendChild(option);
            });
            // Re-render inventory after updating filters
            renderInventory(); 
        };

        window.checkNewCategory = (value) => {
            const newCatInput = document.getElementById('new-category-input');
            if (value === '__NEW__') {
                newCatInput.classList.remove('hidden');
                newCatInput.focus();
            } else {
                newCatInput.classList.add('hidden');
                newCatInput.value = '';
            }
        };

        const saveNewCategory = async (name) => {
            const categoryRef = collection(db, `/artifacts/${appId}/users/${userId}/hvac_categories`);
            // Sanitize name for Firestore ID
            const categoryId = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const newDocRef = doc(categoryRef, categoryId);

            await setDoc(newDocRef, {
                name: name,
                timestamp: serverTimestamp(),
                user_id: userId
            }, { merge: true });
            
            return categoryId;
        };

        // --- Inventory Management ---

        const fetchInventory = () => {
            if (!isAuthReady || !userId) return;

            // Note: We use an indirect query here because Firestore doesn't support complex client-side filtering well
            const inventoryRef = collection(db, `/artifacts/${appId}/users/${userId}/hvac_inventory`);

            onSnapshot(inventoryRef, (snapshot) => {
                window.inventory = [];
                snapshot.forEach(doc => {
                    window.inventory.push({ id: doc.id, ...doc.data() });
                });
                renderInventory(); // Rerender list
                renderInventorySelector(); // Rerender quick-add selector
            }, (error) => {
                console.error("Error fetching inventory:", error);
                showMessage("Could not load inventory parts.", 'bg-red-100 text-red-700');
            });
        };

        // Add default service items if they don't exist
        const defaultItems = [
            { name: "Standard Labor Rate (1 hour)", cost: 75.00, category: "Service/Labor" },
            { name: "Truck/Trip Charge", cost: 45.00, category: "Service/Labor" },
            { name: "AC Filter 16x25x1", cost: 8.50, part_number: "F16251", brand: "Generic", category: "Parts" }
        ];

        const addDefaultServiceItems = async () => {
            if (!isAuthReady || !userId) return;

            const inventoryRef = collection(db, `/artifacts/${appId}/users/${userId}/hvac_inventory`);
            const categoryRef = collection(db, `/artifacts/${appId}/users/${userId}/hvac_categories`);

            for (const item of defaultItems) {
                // FIX: Properly sanitize category name to prevent Firestore path errors (using the same logic as saveNewCategory)
                const categoryId = item.category.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
                
                await setDoc(doc(categoryRef, categoryId), { name: item.category, timestamp: serverTimestamp(), user_id: userId }, { merge: true });

                // Check if item exists (simple check)
                // Note: Using a query to check existence to prevent constant re-creation of default items
                const q = query(inventoryRef, where('name', '==', item.name));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    const docId = item.name.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + Date.now();
                    await setDoc(doc(inventoryRef, docId), {
                        name: item.name,
                        cost: item.cost,
                        category: categoryId, // Use the sanitized ID
                        part_number: item.part_number || '',
                        brand: item.brand || '',
                        timestamp: serverTimestamp(),
                        user_id: userId
                    });
                }
            }
        };
        
        // Render Inventory List with filtering and sorting
        window.renderInventory = () => {
            const listContainer = document.getElementById('inventory-list');
            listContainer.innerHTML = '';
            
            const filterName = document.getElementById('filter-name').value.toLowerCase();
            const filterCatId = document.getElementById('filter-category').value;

            let filteredInventory = window.inventory.filter(part => {
                const nameMatch = part.name.toLowerCase().includes(filterName);
                const numberMatch = part.part_number.toLowerCase().includes(filterName);
                const brandMatch = part.brand.toLowerCase().includes(filterName);
                
                // FIX: Check if filterCatId is not an empty string before applying category filtering
                const categoryMatch = !filterCatId || filterCatId === "" || part.category === filterCatId;

                return (nameMatch || numberMatch || brandMatch) && categoryMatch;
            });
            
            if (filteredInventory.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No matching parts found.</p>';
                return;
            }
            
            // Sort by Name for presentation
            filteredInventory.sort((a, b) => a.name.localeCompare(b.name));

            filteredInventory.forEach(part => {
                const categoryName = window.categories.find(c => c.id === part.category)?.name || 'Uncategorized';
                
                const listItem = document.createElement('div');
                listItem.className = 'flex flex-col p-2 hover:bg-white border-b last:border-b-0 cursor-pointer group';
                listItem.onclick = () => selectPartForJob(part.id); // Click the part to add it to the job
                
                listItem.innerHTML = `
                    <div class="flex justify-between items-start text-sm">
                        <span class="font-medium text-gray-900 truncate pr-2">${part.name}</span>
                        <span class="font-bold text-blue-600 whitespace-nowrap">${formatCurrency(part.cost)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span class="truncate pr-2 italic">${part.brand ? part.brand + ' / ' : ''}${part.part_number || ''}</span>
                        <div class="flex items-center space-x-2">
                             <span class="text-xs font-semibold text-gray-400">(${categoryName})</span>
                             <button onclick="event.stopPropagation(); deleteInventoryPart('${part.id}')" class="text-red-400 hover:text-red-600 text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                &times;
                            </button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(listItem);
            });
        };
        
        const renderInventorySelector = () => {
             const selector = document.getElementById('inventory-selector');
             selector.innerHTML = '<option value="" disabled selected>-- Select a Part or Service from Inventory --</option>';

             if (window.inventory.length === 0) return;

             // Group inventory items by category
             const categorizedItems = window.inventory.reduce((acc, item) => {
                 const catName = window.categories.find(c => c.id === item.category)?.name || 'Uncategorized';
                 if (!acc[catName]) acc[catName] = [];
                 acc[catName].push(item);
                 return acc;
             }, {});

             // Populate the quick-add selector using optgroups
             Object.keys(categorizedItems).sort().forEach(categoryName => {
                 const optgroup = document.createElement('optgroup');
                 optgroup.label = categoryName;

                 categorizedItems[categoryName].sort((a, b) => a.name.localeCompare(b.name)).forEach(part => {
                     const option = document.createElement('option');
                     option.value = part.id;
                     option.textContent = `${part.name} (${formatCurrency(part.cost)})`;
                     optgroup.appendChild(option);
                 });
                 selector.appendChild(optgroup);
             });
        };
        
        window.saveInventoryPart = async () => {
            if (!isAuthReady || !userId) {
                showMessage("Database not ready. Please wait a moment.", 'bg-yellow-100 text-yellow-700');
                return;
            }

            const name = document.getElementById('part-name').value.trim();
            const costInput = document.getElementById('part-cost').value;
            const cost = parseFloat(costInput) || 0;
            let categoryId = document.getElementById('part-category-select').value;
            const newCategoryName = document.getElementById('new-category-input').value.trim();
            
            const partNumber = document.getElementById('part-number').value.trim();
            const brand = document.getElementById('part-brand').value.trim();

            if (!name || cost <= 0 || !categoryId) {
                showMessage("Please enter a valid Item Name, Cost, and Category.", 'bg-yellow-100 text-yellow-700');
                return;
            }

            // Handle new category creation
            if (categoryId === '__NEW__') {
                if (!newCategoryName) {
                    showMessage("Please enter a name for the new category.", 'bg-yellow-100 text-yellow-700');
                    return;
                }
                categoryId = await saveNewCategory(newCategoryName);
            }

            const partData = {
                name: name,
                cost: cost,
                category: categoryId,
                part_number: partNumber,
                brand: brand,
                timestamp: serverTimestamp(),
                user_id: userId
            };

            try {
                const inventoryRef = collection(db, `/artifacts/${appId}/users/${userId}/hvac_inventory`);
                // Sanitize docId to ensure no invalid characters
                const docId = name.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + Date.now(); 
                await setDoc(doc(inventoryRef, docId), partData);

                // Clear fields
                document.getElementById('part-name').value = '';
                document.getElementById('part-cost').value = '';
                document.getElementById('part-number').value = '';
                document.getElementById('part-brand').value = '';
                document.getElementById('part-category-select').value = '';
                document.getElementById('new-category-input').value = '';
                document.getElementById('new-category-input').classList.add('hidden');
                
                showMessage(`Item "${name}" saved successfully!`, 'bg-green-100 text-green-700');

            } catch (e) {
                console.error("Error saving part: ", e);
                showMessage(`Error saving part: ${e.message}`, 'bg-red-100 text-red-700');
            }
        };

        window.deleteInventoryPart = async (id) => {
            if (!isAuthReady || !userId) return;
            
            try {
                const partRef = doc(db, `/artifacts/${appId}/users/${userId}/hvac_inventory/${id}`);
                await deleteDoc(partRef);
                showMessage("Item deleted successfully.", 'bg-blue-100 text-blue-700');
            } catch (e) {
                console.error("Error deleting part: ", e);
                showMessage(`Error deleting item: ${e.message}`, 'bg-red-100 text-red-700');
            }
        };

        // --- Calculator Core Logic ---

        // Function to select an inventory part and add it to line items
        window.selectPartForJob = (partId) => {
            const selector = document.getElementById('inventory-selector');
            selector.value = ''; // Reset selector after selection

            const part = window.inventory.find(p => p.id === partId);
            if (part) {
                window.lineItems.push({
                    id: itemIdCounter++,
                    description: part.name,
                    cost: part.cost,
                    quantity: 1
                });
                renderLineItems();
                showMessage(`Added item "${part.name}" to the estimate.`, 'bg-blue-100 text-blue-700');
            }
        };

        // Function to render the line items in the table
        window.renderLineItems = window.debounce(() => {
            const body = document.getElementById('line-items-body');
            body.innerHTML = ''; 

            window.lineItems.forEach((item) => {
                const totalItemCost = item.cost * item.quantity;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 whitespace-nowrap">
                        <input type="text" value="${item.description}" 
                               oninput="updateLineItem(${item.id}, 'description', this.value)"
                               placeholder="Item Description"
                               class="w-full border-none focus:ring-0 text-sm font-medium text-gray-900"/>
                    </td>
                    <td class="p-3 whitespace-nowrap text-right">
                        <input type="number" value="${item.cost}" min="0" step="0.01" 
                               oninput="updateLineItem(${item.id}, 'cost', parseFloat(this.value) || 0)"
                               class="w-24 text-right border-none focus:ring-0 text-sm"/>
                    </td>
                    <td class="p-3 whitespace-nowrap text-right">
                        <input type="number" value="${item.quantity}" min="1" step="1" 
                               oninput="updateLineItem(${item.id}, 'quantity', parseInt(this.value) || 1)"
                               class="w-16 text-right border-none focus:ring-0 text-sm"/>
                    </td>
                    <td class="p-3 whitespace-nowrap text-right font-medium text-gray-900">
                        ${formatCurrency(totalItemCost)}
                    </td>
                    <td class="p-3 whitespace-nowrap text-right">
                        <button onclick="removeLineItem(${item.id})" class="text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });

            recalculateTotals();
        }, 50);

        // Function to update item properties
        window.updateLineItem = (id, key, value) => {
            const item = window.lineItems.find(i => i.id === id);
            if (item) {
                // Ensure quantity is at least 1 and cost is at least 0
                if (key === 'quantity') item[key] = Math.max(1, value);
                else if (key === 'cost') item[key] = Math.max(0, value);
                else item[key] = value;
            }
            renderLineItems(); 
        };

        // Function to add a new ad-hoc line item
        window.addLineItem = () => {
            window.lineItems.push({
                id: itemIdCounter++,
                description: 'Ad-hoc Item/Service',
                cost: 0.00,
                quantity: 1
            });
            renderLineItems();
        };

        // Function to remove a line item
        window.removeLineItem = (id) => {
            window.lineItems = window.lineItems.filter(item => item.id !== id);
            renderLineItems();
        };

        // Function to recalculate all totals
        window.recalculateTotals = () => {
            let totalCost = 0;
            window.lineItems.forEach(item => {
                totalCost += (item.cost || 0) * (item.quantity || 1);
            });

            const marginPercent = parseFloat(document.getElementById('profit-margin').value) || 0;
            const marginMultiplier = marginPercent / 100;
            const marginAmount = totalCost * marginMultiplier;
            const grandTotal = totalCost + marginAmount;

            document.getElementById('subtotal').textContent = formatCurrency(totalCost);
            document.getElementById('margin-amount').textContent = formatCurrency(marginAmount);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
        };

        // Initialize with a default line item
        window.lineItems.push({
            id: itemIdCounter++,
            description: 'Standard Service Call Fee',
            cost: 80.00,
            quantity: 1
        });

        // --- Estimate Save and Output Functions (Unchanged) ---

        window.saveEstimate = async () => {
            if (!isAuthReady || !userId) {
                showMessage("Database not ready. Please wait a moment and try again.", 'bg-yellow-100 text-yellow-700');
                return;
            }

            const customerName = document.getElementById('customer-name').value.trim();
            if (!customerName) {
                showMessage("Please enter a Customer Name before saving.", 'bg-yellow-100 text-yellow-700');
                return;
            }

            const estimateData = {
                customer: {
                    name: customerName,
                    address: document.getElementById('customer-address').value.trim(),
                    phone: document.getElementById('customer-phone').value.trim(),
                    email: document.getElementById('customer-email').value.trim(),
                },
                items: JSON.stringify(window.lineItems.map(item => ({
                    description: item.description,
                    cost: item.cost,
                    quantity: item.quantity
                }))), 
                margin_percent: parseFloat(document.getElementById('profit-margin').value) || 0,
                total_cost: parseFloat(document.getElementById('subtotal').textContent.replace(/[^0-9.-]+/g, "")),
                customer_price: parseFloat(document.getElementById('grand-total').textContent.replace(/[^0-9.-]+/g, "")),
                timestamp: serverTimestamp(),
                user_id: userId
            };

            try {
                const docId = `estimate_${Date.now()}`;
                const userRef = doc(db, `/artifacts/${appId}/users/${userId}/hvac_estimates/${docId}`);

                await setDoc(userRef, estimateData);
                showMessage(`Estimate for ${customerName} saved successfully! ID: ${docId}`, 'bg-blue-100 text-blue-700');

            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage(`Error saving estimate: ${e.message}`, 'bg-red-100 text-red-700');
            }
        };

        window.generateEstimateText = () => {
            let emailBody = "HVAC Service Job Estimate\n\n";
            emailBody += "--- Customer Details ---\n";
            emailBody += `Name: ${document.getElementById('customer-name').value.trim() || 'N/A'}\n`;
            emailBody += `Address: ${document.getElementById('customer-address').value.trim() || 'N/A'}\n`;
            emailBody += `Phone: ${document.getElementById('customer-phone').value.trim() || 'N/A'}\n`;
            emailBody += `Email: ${document.getElementById('customer-email').value.trim() || 'N/A'}\n\n`;

            emailBody += "--- Itemized Services & Parts ---\n";
            window.lineItems.forEach(item => {
                emailBody += `- ${item.quantity}x ${item.description}\n`;
            });
            emailBody += "\n*Note: The customer price includes all services, parts, and the applied profit margin.*\n\n";

            const grandTotal = document.getElementById('grand-total').textContent;
            emailBody += "--- Total Charge ---\n";
            emailBody += `\n**Customer Final Price: ${grandTotal}**\n\n`;
            emailBody += "Thank you for choosing our service!\n\n";

            try {
                navigator.clipboard.writeText(emailBody);
                showMessage("Estimate text copied to clipboard!", 'bg-blue-100 text-blue-700');
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = emailBody;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showMessage("Estimate text copied to clipboard! (using fallback)", 'bg-blue-100 text-blue-700');
            }
        };


        // Initialize on load
        window.addEventListener('load', () => {
            initializeFirebase();
            renderLineItems();

            // Attach event listeners for dynamic updates
            document.getElementById('profit-margin').addEventListener('input', recalculateTotals);
            document.getElementById('line-items-body').addEventListener('input', renderLineItems); 
            
            // Re-render inventory when filter category changes
            document.getElementById('filter-category').addEventListener('change', renderInventory);
        });

        // Expose functions globally for use in HTML attributes
        window.addLineItem = addLineItem;
        window.removeLineItem = removeLineItem;
        window.updateLineItem = updateLineItem;
        window.recalculateTotals = recalculateTotals;
        window.saveEstimate = saveEstimate;
        window.generateEstimateText = generateEstimateText;
        window.saveInventoryPart = saveInventoryPart;
        window.deleteInventoryPart = deleteInventoryPart;
        window.selectPartForJob = selectPartForJob;
        window.checkNewCategory = checkNewCategory; // Exposed for HTML interaction
    </script>
</body>
</html>
