<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Field Service Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .unit-tab-active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        input:checked + label { background-color: #eff6ff; color: #2563eb; font-weight: 500; }
        #serviceListContainer { max-height: 65vh; overflow-y: auto; }
        .input-field { @apply block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm; }
        .btn-google { @apply px-4 py-2 bg-white text-gray-700 rounded-lg font-semibold border border-gray-300 hover:bg-gray-50 transition duration-200 shadow-sm flex items-center justify-center space-x-2 text-sm; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-indicator" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col">
        <svg class="animate-spin h-10 w-10 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-blue-600 font-medium">Connecting to Database...</span>
    </div>

    <div class="container mx-auto p-4 max-w-6xl">

        <header class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img src="https://imageview.mechanicaltemp.com/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Logo" class="h-12 w-auto">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">HVAC Service Pro</h1>
                    <p class="text-xs text-green-600 font-semibold" id="connection-status">‚óè Database Connected</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end space-y-2">
                <div id="auth-ui">
                    <button id="google-sign-in" class="btn-google">
                        <i class="fab fa-google text-blue-500"></i>
                        <span>Sign In to Cloud</span>
                    </button>
                    <div id="user-panel" class="hidden flex items-center space-x-3">
                        <span id="user-email" class="text-sm text-gray-600 font-medium"></span>
                        <button id="google-sign-out" class="text-sm text-red-500 hover:text-red-700 underline">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <div id="message-box" class="hidden p-4 rounded-lg text-sm mb-6 transition-opacity duration-300 font-semibold text-center" role="alert"></div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-md flex flex-col h-full">
                <h3 class="font-bold text-lg mb-2 text-gray-800">Quick Select Services</h3>
                <div class="flex border-b mb-4 flex-shrink-0 text-sm overflow-x-auto">
                    <button data-tab="residential" class="tab-btn flex-shrink-0 py-2 px-3 text-center text-gray-600 hover:bg-gray-50 rounded-t-lg tab-active">Residential</button>
                    <button data-tab="commercial" class="tab-btn flex-shrink-0 py-2 px-3 text-center text-gray-600 hover:bg-gray-50 rounded-t-lg">Commercial</button>
                </div>
                <div id="serviceListContainer" class="flex-grow pr-2">
                    </div>
            </div>

            <div id="jobDetailsPanel" class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                
                <div class="mb-6 border-b pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Customer Information</h2>
                        <div class="flex space-x-2">
                            <input type="file" id="csvInput" accept=".csv" class="hidden">
                            <button onclick="document.getElementById('csvInput').click()" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 flex items-center">
                                <i class="fa fa-file-csv mr-1"></i> üìÇ Import AppSheet CSV
                            </button>
                            <button id="saveCloudBtn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 hidden">
                                <i class="fa fa-cloud-upload-alt mr-1"></i> Save to Cloud
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="relative">
                            <input type="text" id="customerName" placeholder="Search Customer Name..." list="customerOptions" class="input-field" autocomplete="off">
                            <datalist id="customerOptions"></datalist> </div>
                        <input type="text" id="customerContact" placeholder="Contact / Bill To" class="input-field">
                        <input type="text" id="customerAddress" placeholder="Service Address" class="input-field sm:col-span-2">
                    </div>
                    <p id="csv-status" class="text-xs text-gray-500 mt-2 italic text-right"></p>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold">Units / Systems</h2>
                        <div class="flex space-x-2">
                            <button id="addUnitBtn" class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-semibold rounded hover:bg-blue-200">+ Add Unit</button>
                            <button id="removeUnitBtn" class="px-3 py-1 bg-red-100 text-red-700 text-sm font-semibold rounded hover:bg-red-200"><i class="fa fa-trash"></i></button>
                        </div>
                    </div>
                    <div id="unitTabs" class="flex items-center space-x-1 border-b border-gray-200 overflow-x-auto pb-1 mb-4">
                        </div>
                    <div id="unitDetailsContainer">
                        </div>
                </div>

                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-bold mb-2">Custom Parts & Inventory</h2>
                    
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                        <div class="flex flex-col sm:flex-row gap-2 mb-2">
                            <select id="inventory-selector" class="input-field flex-grow">
                                <option value="" disabled selected>-- Quick Add from Inventory --</option>
                            </select>
                            <button id="addInventoryItemBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 whitespace-nowrap">Add</button>
                        </div>
                        <div class="text-center text-xs text-gray-500 font-medium">OR Add Custom Manual Item</div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-2">
                            <input type="text" id="customPartName" placeholder="Description" class="input-field flex-[2]">
                            <input type="number" id="customPartCost" placeholder="Cost ($)" class="input-field flex-1">
                            <input type="number" id="customPartQty" placeholder="Qty" value="1" class="input-field w-20">
                            <button id="addCustomLineItemBtn" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">Add</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2">Description</th>
                                    <th class="px-4 py-2 text-right">Cost</th>
                                    <th class="px-4 py-2 text-right">Qty</th>
                                    <th class="px-4 py-2 text-center">Delete</th>
                                </tr>
                            </thead>
                            <tbody id="combinedLineItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-8 bg-slate-800 text-white p-6 rounded-lg shadow-lg">
                    <h3 class="font-bold text-lg mb-4 text-slate-300 border-b border-slate-600 pb-2">Financial Summary</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Labor Hours:</label>
                                <input type="number" id="laborHours" class="w-20 p-1 text-black rounded text-center" step="0.5">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Labor Rate ($/hr):</label>
                                <input type="number" id="laborRate" class="w-20 p-1 text-black rounded text-center" value="125">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Trip Charge:</label>
                                <input type="number" id="tripCharge" class="w-20 p-1 text-black rounded text-center" value="45">
                            </div>
                        </div>

                        <div class="space-y-2 text-right">
                            <div class="flex justify-between"><span>Parts Cost:</span> <span id="totalParts" class="font-mono">$0.00</span></div>
                            <div class="flex justify-between"><span>Labor Cost:</span> <span id="totalLabor" class="font-mono">$0.00</span></div>
                            <div class="flex justify-between border-t border-slate-600 pt-2 font-bold"><span>Subtotal:</span> <span id="subtotalCost" class="font-mono">$0.00</span></div>
                            
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-600">
                                <div class="flex items-center">
                                    <span class="mr-2 text-sm">Margin:</span>
                                    <input type="number" id="marginPercent" class="w-16 p-1 text-black rounded text-center font-bold" value="50">
                                    <span class="ml-1">%</span>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-400">Total Price</div>
                                    <div id="grandTotal" class="text-2xl font-bold text-green-400 font-mono">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <select id="pdfOption" class="input-field sm:w-1/3">
                        <option value="t&m">Show Breakdown (T&M)</option>
                        <option value="flatRate">Show Flat Rate Only</option>
                    </select>
                    <button id="generatePdfBtn" class="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 transition">
                        <i class="fa fa-file-pdf mr-2"></i> Generate PDF
                    </button>
                </div>

            </div>
        </main>
    </div>

    <input type="file" id="photoInput" class="hidden" accept="image/*" capture="camera">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDYjrKUuujTaaUe6AIhhcIcmHc93KTQI1M",
            authDomain: "hvac-service-proposal-tool.firebaseapp.com",
            projectId: "hvac-service-proposal-tool",
            storageBucket: "hvac-service-proposal-tool.firebasestorage.app",
            messagingSenderId: "10017474274",
            appId: "1:10017474274:web:1f64fe7b7edb807d3900bb"
        };
        const { jsPDF } = window.jspdf;

        // --- 2. DATA CONSTANTS ---
        const quickJobs = {
            acMaintenance: { title: 'A/C Maintenance', cost: 15, labor: 1.5 },
            furnaceMaintenance: { title: 'Furnace Maintenance', cost: 15, labor: 1.5 },
            diagnostic: { title: 'Diagnostic / Service Call', cost: 0, labor: 1.0 },
            capacitor: { title: 'Capacitor Replacement', cost: 25, labor: 0.5 },
            contactor: { title: 'Contactor Replacement', cost: 20, labor: 0.5 },
            recharge: { title: 'Refrigerant Recharge (lb)', cost: 35, labor: 0.5 },
            leakSearch: { title: 'Leak Search', cost: 10, labor: 1.5 },
            coilClean: { title: 'Chem Clean Coils', cost: 25, labor: 1.0 },
            blowerMotor: { title: 'Blower Motor', cost: 150, labor: 2.0 },
            condenserMotor: { title: 'Condenser Fan Motor', cost: 120, labor: 1.5 },
            ignitor: { title: 'Hot Surface Ignitor', cost: 40, labor: 0.5 },
            flameSensor: { title: 'Flame Sensor Clean/Repl', cost: 15, labor: 0.5 },
            drainClear: { title: 'Clear Drain Line', cost: 5, labor: 1.0 }
        };

        const serviceCategories = {
            residential: ["acMaintenance", "furnaceMaintenance", "diagnostic", "capacitor", "contactor", "recharge", "leakSearch", "coilClean", "drainClear", "ignitor"],
            commercial: ["diagnostic", "acMaintenance", "furnaceMaintenance", "recharge", "blowerMotor", "condenserMotor", "contactor", "capacitor"]
        };

        // --- 3. STATE MANAGEMENT ---
        let app, auth, db, userId;
        let units = [];
        let activeUnitId = null;
        let customLineItems = []; 
        let inventory = []; 
        let customerDB = {}; // Stores imported CSV data

        // --- 4. FIREBASE INIT ---
        try {
            app = initializeApp(FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, (user) => {
                document.getElementById('loading-indicator').classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    handleLoginUI(user);
                    loadInventory(); 
                } else {
                    userId = null;
                    handleLogoutUI();
                }
            });
        } catch (e) { console.error("Firebase Error", e); }

        // --- 5. CORE FUNCTIONS ---
        function initApp() {
            renderServiceChecklists('residential');
            loadCachedCustomers(); // Load customers from local storage on startup

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                    e.target.classList.add('tab-active');
                    renderServiceChecklists(e.target.dataset.tab);
                });
            });

            if(units.length === 0) addUnit(); 

            // Listener Assignments
            document.getElementById('addUnitBtn').addEventListener('click', addUnit);
            document.getElementById('removeUnitBtn').addEventListener('click', removeActiveUnit);
            document.getElementById('addCustomLineItemBtn').addEventListener('click', addCustomItemFromInput);
            document.getElementById('addInventoryItemBtn').addEventListener('click', addInventoryItem);
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
            document.getElementById('csvInput').addEventListener('change', handleCsvUpload);
            document.getElementById('customerName').addEventListener('input', autofillCustomer);
            
            ['laborHours', 'laborRate', 'tripCharge', 'marginPercent'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateTotals);
            });

            document.getElementById('google-sign-in').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
            document.getElementById('google-sign-out').addEventListener('click', () => signOut(auth));
            document.getElementById('saveCloudBtn').addEventListener('click', saveToCloud);
            document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
        }

        // --- CSV IMPORT LOGIC ---
        function handleCsvUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const count = processCsvData(results.data);
                    showMessage(`Successfully imported ${count} customers!`, "bg-green-100 text-green-700");
                    document.getElementById('csv-status').textContent = `Loaded ${count} customers from CSV`;
                },
                error: function(err) {
                    alert("Error parsing CSV: " + err.message);
                }
            });
        }

        function processCsvData(rows) {
            let count = 0;
            rows.forEach(row => {
                // Mapping based on AppSheet.ViewData structure
                const name = row['Customer'];
                if (name) {
                    customerDB[name] = {
                        address: row['Service Address'] || '',
                        contact: row['Bill To'] || '',
                        type: (row['Location Type'] || '').toLowerCase().includes('commercial') ? 'commercial' : 'residential'
                    };
                    count++;
                }
            });
            
            // Save to LocalStorage for persistence across reloads
            localStorage.setItem('hvac_customer_db', JSON.stringify(customerDB));
            populateCustomerList();
            return count;
        }

        function loadCachedCustomers() {
            const cached = localStorage.getItem('hvac_customer_db');
            if (cached) {
                try {
                    customerDB = JSON.parse(cached);
                    const count = Object.keys(customerDB).length;
                    if (count > 0) {
                        document.getElementById('csv-status').textContent = `Loaded ${count} cached customers`;
                        populateCustomerList();
                    }
                } catch (e) { console.error("Cache error", e); }
            }
        }

        function populateCustomerList() {
            const datalist = document.getElementById('customerOptions');
            datalist.innerHTML = '';
            Object.keys(customerDB).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
        }

        function autofillCustomer(e) {
            const val = e.target.value;
            const data = customerDB[val];
            if (data) {
                document.getElementById('customerAddress').value = data.address;
                document.getElementById('customerContact').value = data.contact;
                
                // Switch tabs based on location type
                if (data.type) {
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        if (btn.dataset.tab === data.type) btn.click();
                    });
                }
                showMessage("Customer details autofilled!", "bg-blue-100 text-blue-700");
            }
        }

        // --- UNIT LOGIC ---
        function createUnit(id) {
            return { id, name: `Unit ${units.length + 1}`, brand: '', model: '', serial: '', notes: '', photos: [], selectedServices: new Set() };
        }

        function addUnit() {
            const id = Date.now();
            units.push(createUnit(id));
            setActiveUnit(id);
        }

        function removeActiveUnit() {
            if(units.length <= 1) return alert("Keep at least one unit.");
            units = units.filter(u => u.id !== activeUnitId);
            setActiveUnit(units[0].id);
        }

        function setActiveUnit(id) {
            activeUnitId = id;
            renderUnitTabs();
            renderUnitDetails();
            updateCheckboxes();
        }

        function renderUnitTabs() {
            const container = document.getElementById('unitTabs');
            container.innerHTML = '';
            units.forEach(u => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 text-sm font-medium rounded-t-lg border-t border-l border-r ${u.id === activeUnitId ? 'unit-tab-active' : 'bg-gray-100 hover:bg-gray-200'}`;
                btn.textContent = u.name;
                btn.onclick = () => setActiveUnit(u.id);
                container.appendChild(btn);
            });
        }

        function renderUnitDetails() {
            const u = units.find(unit => unit.id === activeUnitId);
            const container = document.getElementById('unitDetailsContainer');
            if(!u) return;

            container.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <input type="text" value="${u.name}" class="input-field" onchange="updateUnit('${u.id}', 'name', this.value)" placeholder="Unit Name (e.g. RTU-1)">
                    <input type="text" value="${u.brand}" class="input-field" onchange="updateUnit('${u.id}', 'brand', this.value)" placeholder="Brand">
                    <input type="text" value="${u.model}" class="input-field" onchange="updateUnit('${u.id}', 'model', this.value)" placeholder="Model #">
                    <input type="text" value="${u.serial}" class="input-field" onchange="updateUnit('${u.id}', 'serial', this.value)" placeholder="Serial #">
                </div>
                <textarea class="input-field h-20 mb-4" placeholder="Diagnosis / Notes" onchange="updateUnit('${u.id}', 'notes', this.value)">${u.notes}</textarea>
                
                <div class="flex flex-wrap gap-2 mb-2" id="photoGallery-${u.id}">
                    ${u.photos.map((src, idx) => `<div class="relative w-16 h-16"><img src="${src}" class="w-full h-full object-cover rounded border"><button onclick="removePhoto('${u.id}', ${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center">&times;</button></div>`).join('')}
                </div>
                <button onclick="document.getElementById('photoInput').click()" class="text-sm text-blue-600 hover:underline"><i class="fa fa-camera"></i> Add Photo</button>
            `;
        }

        window.updateUnit = (id, field, val) => {
            const u = units.find(unit => unit.id === id);
            if(u) { u[field] = val; if(field === 'name') renderUnitTabs(); }
        }

        // --- CHECKLIST & CALCS ---
        function renderServiceChecklists(type) {
            const container = document.getElementById('serviceListContainer');
            container.innerHTML = '';
            const list = serviceCategories[type];
            list.forEach(key => {
                const item = quickJobs[key];
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 hover:bg-gray-50 rounded';
                div.innerHTML = `
                    <input type="checkbox" id="cb-${key}" data-key="${key}" class="service-cb w-4 h-4 text-blue-600 rounded">
                    <label for="cb-${key}" class="ml-2 text-sm text-gray-700 w-full cursor-pointer select-none">${item.title}</label>
                `;
                container.appendChild(div);
            });
            
            document.querySelectorAll('.service-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const u = units.find(unit => unit.id === activeUnitId);
                    if(!u) return;
                    if(e.target.checked) u.selectedServices.add(e.target.dataset.key);
                    else u.selectedServices.delete(e.target.dataset.key);
                    calculateTotals();
                });
            });
            updateCheckboxes();
        }

        function updateCheckboxes() {
            const u = units.find(unit => unit.id === activeUnitId);
            document.querySelectorAll('.service-cb').forEach(cb => {
                cb.checked = u && u.selectedServices.has(cb.dataset.key);
            });
        }

        function loadInventory() {
            if(!userId) return;
            const ref = collection(db, `artifacts/${FIREBASE_CONFIG.appId}/users/${userId}/hvac_inventory`);
            onSnapshot(ref, (snap) => {
                inventory = [];
                const select = document.getElementById('inventory-selector');
                select.innerHTML = '<option value="" disabled selected>-- Quick Add from Inventory --</option>';
                snap.forEach(doc => {
                    const data = doc.data();
                    inventory.push({ id: doc.id, ...data });
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = `${data.name} ($${data.cost})`;
                    select.appendChild(opt);
                });
            });
        }

        function addInventoryItem() {
            const id = document.getElementById('inventory-selector').value;
            const item = inventory.find(i => i.id === id);
            if(item) addCustomLineItem(item.name, item.cost, 1);
        }

        function addCustomItemFromInput() {
            const name = document.getElementById('customPartName').value;
            const cost = parseFloat(document.getElementById('customPartCost').value) || 0;
            const qty = parseFloat(document.getElementById('customPartQty').value) || 1;
            if(name) {
                addCustomLineItem(name, cost, qty);
                document.getElementById('customPartName').value = '';
                document.getElementById('customPartCost').value = '';
            }
        }

        function addCustomLineItem(description, cost, qty) {
            customLineItems.push({ id: Date.now(), description, cost, qty, unitId: activeUnitId });
            calculateTotals();
        }

        window.removeLineItem = (id) => {
            customLineItems = customLineItems.filter(i => i.id !== id);
            calculateTotals();
        }

        function calculateTotals() {
            let partsTotal = 0;
            let laborHrsTotal = 0;
            const tbody = document.getElementById('combinedLineItemsBody');
            tbody.innerHTML = '';

            units.forEach(u => {
                u.selectedServices.forEach(key => {
                    const job = quickJobs[key];
                    partsTotal += job.cost;
                    laborHrsTotal += job.labor;
                    tbody.innerHTML += `
                        <tr class="bg-blue-50/50 border-b">
                            <td class="px-4 py-2 font-medium text-xs">${u.name}: ${job.title}</td>
                            <td class="px-4 py-2 text-right text-xs">$${job.cost.toFixed(2)}</td>
                            <td class="px-4 py-2 text-right text-xs">1</td>
                            <td class="px-4 py-2 text-center text-xs text-gray-400">Fixed</td>
                        </tr>
                    `;
                });
            });

            customLineItems.forEach(item => {
                partsTotal += (item.cost * item.quantity);
                const uName = units.find(u => u.id === item.unitId)?.name || 'General';
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="px-4 py-2 text-sm">${uName}: ${item.description}</td>
                        <td class="px-4 py-2 text-right text-sm">$${item.cost.toFixed(2)}</td>
                        <td class="px-4 py-2 text-right text-sm">${item.quantity}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="removeLineItem(${item.id})" class="text-red-500 hover:text-red-700">&times;</button>
                        </td>
                    </tr>
                `;
            });

            const manualLabor = parseFloat(document.getElementById('laborHours').value);
            const finalLaborHrs = isNaN(manualLabor) ? laborHrsTotal : manualLabor;
            if(isNaN(manualLabor)) document.getElementById('laborHours').placeholder = laborHrsTotal.toFixed(1);

            const rate = parseFloat(document.getElementById('laborRate').value) || 0;
            const trip = parseFloat(document.getElementById('tripCharge').value) || 0;
            const laborCost = finalLaborHrs * rate;
            const subtotal = partsTotal + laborCost + trip;
            const margin = parseFloat(document.getElementById('marginPercent').value) || 0;
            const price = margin > 0 && margin < 100 ? subtotal / (1 - (margin/100)) : subtotal;

            document.getElementById('totalParts').textContent = `$${partsTotal.toFixed(2)}`;
            document.getElementById('totalLabor').textContent = `$${laborCost.toFixed(2)}`;
            document.getElementById('subtotalCost').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `$${price.toFixed(2)}`;
        }

        // --- AUTH & HELPERS ---
        function handleLoginUI(user) {
            document.getElementById('google-sign-in').classList.add('hidden');
            document.getElementById('user-panel').classList.remove('hidden');
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('saveCloudBtn').classList.remove('hidden');
            document.getElementById('connection-status').className = "text-xs text-green-600 font-semibold";
            document.getElementById('connection-status').textContent = "‚óè Database Connected";
        }

        function handleLogoutUI() {
            document.getElementById('google-sign-in').classList.remove('hidden');
            document.getElementById('user-panel').classList.add('hidden');
            document.getElementById('saveCloudBtn').classList.add('hidden');
            document.getElementById('connection-status').className = "text-xs text-gray-400";
            document.getElementById('connection-status').textContent = "‚óã Local Mode Only";
        }

        async function saveToCloud() {
            if(!userId) return alert("Sign in first.");
            const name = document.getElementById('customerName').value;
            if(!name) return alert("Customer Name Required");
            const data = {
                customer: {
                    name,
                    contact: document.getElementById('customerContact').value,
                    address: document.getElementById('customerAddress').value
                },
                units: units.map(u => ({...u, selectedServices: Array.from(u.selectedServices)})),
                customLineItems,
                financials: {
                    laborRate: document.getElementById('laborRate').value,
                    trip: document.getElementById('tripCharge').value,
                    margin: document.getElementById('marginPercent').value,
                    total: document.getElementById('grandTotal').textContent
                },
                timestamp: serverTimestamp()
            };
            try {
                await setDoc(doc(collection(db, `artifacts/${FIREBASE_CONFIG.appId}/users/${userId}/hvac_estimates`)), data);
                showMessage("Estimate Saved to Cloud!", "bg-green-100 text-green-700");
            } catch(e) { console.error(e); alert("Error saving."); }
        }

        function handlePhotoUpload(e) {
            const u = units.find(unit => unit.id === activeUnitId);
            if(!u || !e.target.files[0]) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                u.photos.push(ev.target.result);
                renderUnitDetails();
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        window.removePhoto = (uId, idx) => {
            const u = units.find(unit => unit.id == uId);
            if(u) { u.photos.splice(idx, 1); renderUnitDetails(); }
        }

        function showMessage(msg, classes) {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.className = `p-4 rounded-lg text-sm mb-6 transition-opacity duration-300 font-semibold text-center ${classes}`;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        async function generatePDF() {
            const doc = new jsPDF();
            const margin = 15;
            let y = 20;

            doc.setFontSize(22).setTextColor(40).text("HVAC Service Report", margin, y);
            y += 10;
            doc.setFontSize(10).setTextColor(100).text("Mechanical Temp Service", margin, y);
            y += 15;

            doc.setDrawColor(200); doc.line(margin, y, 195, y); y += 10;
            doc.setFontSize(12).setTextColor(0).text("Customer:", margin, y); doc.setFontSize(10); y += 6;
            doc.text(`Name: ${document.getElementById('customerName').value}`, margin, y); y += 5;
            doc.text(`Address: ${document.getElementById('customerAddress').value}`, margin, y); y += 10;

            units.forEach(u => {
                if(y > 250) { doc.addPage(); y = 20; }
                doc.setFontSize(14).setFont(undefined, 'bold').text(`${u.name} (${u.brand || 'N/A'})`, margin, y);
                y += 7;
                doc.setFontSize(10).setFont(undefined, 'normal');
                if(u.notes) {
                    const splitNotes = doc.splitTextToSize(`Notes: ${u.notes}`, 170);
                    doc.text(splitNotes, margin, y);
                    y += (splitNotes.length * 5) + 5;
                }
                u.selectedServices.forEach(key => { doc.text(`[x] ${quickJobs[key].title}`, margin + 5, y); y += 5; });
                customLineItems.filter(i => i.unitId === u.id).forEach(i => { doc.text(`- ${i.description} (Qty: ${i.quantity})`, margin + 5, y); y += 5; });
                y += 10;
            });

            y = 250; doc.line(margin, y, 195, y); y += 10;
            doc.setFontSize(14).setFont(undefined, 'bold');
            
            if(document.getElementById('pdfOption').value === 'flatRate') {
                doc.text(`Total Investment: ${document.getElementById('grandTotal').textContent}`, margin, y);
            } else {
                doc.setFontSize(10);
                doc.text(`Parts: ${document.getElementById('totalParts').textContent}`, margin, y); y+=5;
                doc.text(`Labor: ${document.getElementById('totalLabor').textContent}`, margin, y); y+=5;
                doc.setFontSize(14);
                doc.text(`Total: ${document.getElementById('grandTotal').textContent}`, margin, y+5);
            }
            doc.save('Service_Report.pdf');
        }

        initApp();
    </script>
</body>
</html>
