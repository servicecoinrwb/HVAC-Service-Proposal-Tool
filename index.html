<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Field Service Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .unit-tab-active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        input:checked + label { background-color: #eff6ff; color: #2563eb; font-weight: 500; }
        #serviceListContainer { max-height: 65vh; overflow-y: auto; }
        .input-field { 
            @apply block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out; 
        }
        .btn-google { @apply px-4 py-2 bg-white text-gray-700 rounded-lg font-semibold border border-gray-300 hover:bg-gray-50 transition duration-200 shadow-sm flex items-center justify-center space-x-2 text-sm; }
        
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-indicator" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col">
        <svg class="animate-spin h-10 w-10 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-blue-600 font-medium">Connecting to Database...</span>
    </div>

    <div id="serviceManagerModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">Manage Services & Pricing</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleServiceModal()">
                        <i class="fas fa-times text-gray-500 hover:text-red-500 text-xl"></i>
                    </div>
                </div>
                <div class="my-5">
                    <div class="flex justify-end mb-4 gap-2">
                         <button onclick="resetDefaultServices()" class="text-xs text-red-500 hover:underline mr-auto">Reset to Defaults</button>
                        <button onclick="addNewServiceRow()" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">+ Add New Service</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-100 text-left">
                                    <th class="p-2">Category</th>
                                    <th class="p-2">Service Name</th>
                                    <th class="p-2 w-24">Cost ($)</th>
                                    <th class="p-2 w-20">Labor (Hr)</th>
                                    <th class="p-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="serviceManagerBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="flex justify-end pt-2 border-t gap-2">
                    <button onclick="toggleServiceModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-gray-800">Cancel</button>
                    <button onclick="saveCustomServices()" class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 text-white font-bold">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">

        <header class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img src="https://imageview.mechanicaltemp.com/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Logo" class="h-12 w-auto">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">HVAC Service Pro</h1>
                    <p class="text-xs text-green-600 font-semibold" id="connection-status">● Database Connected</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end space-y-2">
                <div id="auth-ui">
                    <button id="google-sign-in" class="btn-google">
                        <i class="fab fa-google text-blue-500"></i>
                        <span>Sign In to Cloud</span>
                    </button>
                    <div id="user-panel" class="hidden flex items-center space-x-3">
                        <span id="user-email" class="text-sm text-gray-600 font-medium"></span>
                        <button id="google-sign-out" class="text-sm text-red-500 hover:text-red-700 underline">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <div id="message-box" class="hidden p-4 rounded-lg text-sm mb-6 transition-opacity duration-300 font-semibold text-center" role="alert"></div>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">1. Customer & Job Information</h2>
                <div class="flex space-x-2">
                    <input type="file" id="csvInput" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('csvInput').click()" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 flex items-center transition">
                        <i class="fa fa-file-csv mr-1"></i> Import CSV
                    </button>
                    <button id="saveCloudBtn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 hidden transition">
                        <i class="fa fa-cloud-upload-alt mr-1"></i> Save Job
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Work Order #</label>
                    <input type="text" id="workOrderNo" placeholder="WO-12345" class="input-field border-l-4 border-l-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Customer Search</label>
                    <input type="text" id="customerName" placeholder="Search Database..." list="customerOptions" class="input-field" autocomplete="off">
                    <datalist id="customerOptions"></datalist>
                </div>
                <div>
                     <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Contact / Bill To</label>
                    <input type="text" id="customerContact" class="input-field">
                </div>
                 <div>
                     <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Service Address</label>
                    <input type="text" id="customerAddress" class="input-field">
                </div>
            </div>
            <p id="csv-status" class="text-xs text-gray-500 mt-2 italic text-right"></p>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-gray-800">2. Unit Details & Diagnosis</h2>
                <div class="flex space-x-2">
                    <button id="addUnitBtn" class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-semibold rounded hover:bg-blue-200">+ Add Unit</button>
                    <button id="removeUnitBtn" class="px-3 py-1 bg-red-100 text-red-700 text-sm font-semibold rounded hover:bg-red-200"><i class="fa fa-trash"></i></button>
                </div>
            </div>
            <div id="unitTabs" class="flex items-center space-x-1 border-b border-gray-200 overflow-x-auto pb-1 mb-4"></div>
            <div id="unitDetailsContainer"></div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-1 bg-white p-4 rounded-lg shadow-md flex flex-col h-full">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg text-gray-800">3. Quick Services</h3>
                    <button onclick="toggleServiceModal()" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700 font-semibold">
                        <i class="fa fa-cog mr-1"></i> Edit
                    </button>
                </div>
                
                <div class="flex border-b mb-4 flex-shrink-0 text-sm overflow-x-auto">
                    <button data-tab="residential" class="tab-btn flex-shrink-0 py-2 px-3 text-center text-gray-600 hover:bg-gray-50 rounded-t-lg tab-active">Residential</button>
                    <button data-tab="commercial" class="tab-btn flex-shrink-0 py-2 px-3 text-center text-gray-600 hover:bg-gray-50 rounded-t-lg">Commercial</button>
                </div>
                <div id="serviceListContainer" class="flex-grow pr-2"></div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">4. Parts & Services Breakdown</h2>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                        <div class="flex flex-col sm:flex-row gap-2 mb-2">
                            <select id="inventory-selector" class="input-field flex-grow">
                                <option value="" disabled selected>-- Quick Add from Inventory --</option>
                            </select>
                            <button id="addInventoryItemBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 whitespace-nowrap">Add</button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-2">
                            <input type="text" id="customPartName" placeholder="Manual Item Description" class="input-field flex-[2]">
                            <input type="number" id="customPartCost" placeholder="Cost ($)" class="input-field flex-1">
                            <input type="number" id="customPartQty" placeholder="Qty" value="1" class="input-field w-20">
                            <button id="addCustomLineItemBtn" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">Add</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2">Description</th>
                                    <th class="px-4 py-2 text-right">Cost</th>
                                    <th class="px-4 py-2 text-right">Qty</th>
                                    <th class="px-4 py-2 text-center"></th>
                                </tr>
                            </thead>
                            <tbody id="combinedLineItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-slate-800 text-white p-6 rounded-lg shadow-lg">
                    <h3 class="font-bold text-lg mb-4 text-slate-300 border-b border-slate-600 pb-2">5. Financial Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Labor Hours:</label>
                                <input type="number" id="laborHours" class="w-20 p-1 text-black rounded text-center font-bold" step="0.5" value="0">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Labor Rate ($/hr):</label>
                                <input type="number" id="laborRate" class="w-20 p-1 text-black rounded text-center" value="125">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Trip Charge:</label>
                                <input type="number" id="tripCharge" class="w-20 p-1 text-black rounded text-center" value="45">
                            </div>
                        </div>

                        <div class="space-y-2 text-right">
                            <div class="flex justify-between"><span>Parts Cost:</span> <span id="totalParts" class="font-mono">$0.00</span></div>
                            <div class="flex justify-between"><span>Labor Cost:</span> <span id="totalLabor" class="font-mono">$0.00</span></div>
                            <div class="flex justify-between border-t border-slate-600 pt-2 font-bold"><span>Subtotal:</span> <span id="subtotalCost" class="font-mono">$0.00</span></div>
                            
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-600">
                                <div class="flex items-center">
                                    <span class="mr-2 text-sm">Margin:</span>
                                    <input type="number" id="marginPercent" class="w-16 p-1 text-black rounded text-center font-bold" value="50">
                                    <span class="ml-1">%</span>
                                </div>
                                <div class="flex flex-col items-end">
                                    <div class="text-xs text-green-400 mb-1" id="profitDisplay">Profit: $0.00</div>
                                    <div id="grandTotal" class="text-2xl font-bold text-green-400 font-mono">$0.00</div>
                                    <div class="text-xs text-slate-400">Total Customer Price</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div class="flex flex-col sm:flex-row gap-4">
                    <select id="pdfOption" class="input-field sm:w-1/3">
                        <option value="t&m">Show Breakdown (T&M)</option>
                        <option value="flatRate">Show Flat Rate Only</option>
                    </select>
                    <button id="generatePdfBtn" class="flex-1 bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 transition">
                        <i class="fa fa-file-pdf mr-2"></i> Generate PDF
                    </button>
                </div>

            </div>
        </div>

    </div>

    <input type="file" id="photoInput" class="hidden" accept="image/*" capture="camera">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDYjrKUuujTaaUe6AIhhcIcmHc93KTQI1M",
            authDomain: "hvac-service-proposal-tool.firebaseapp.com",
            projectId: "hvac-service-proposal-tool",
            storageBucket: "hvac-service-proposal-tool.firebasestorage.app",
            messagingSenderId: "10017474274",
            appId: "1:10017474274:web:1f64fe7b7edb807d3900bb"
        };
        const { jsPDF } = window.jspdf;

        // Data Constants
        const brandOptions = [
            "Carrier", "Trane", "Lennox", "Goodman", "Rheem", "York", "American Standard", 
            "Bryant", "Daikin", "Mitsubishi", "Fujitsu", "LG", "Samsung", "Aaon", "Liebert", "Other"
        ];
        const DEFAULT_JOBS = {
            acMaintenance: { title: 'A/C Maintenance', cost: 15, labor: 1.5, category: 'residential' },
            furnaceMaintenance: { title: 'Furnace Maintenance', cost: 15, labor: 1.5, category: 'residential' },
            diagnostic: { title: 'Diagnostic / Service Call', cost: 0, labor: 1.0, category: 'both' },
            capacitor: { title: 'Capacitor Replacement', cost: 25, labor: 0.5, category: 'both' },
            contactor: { title: 'Contactor Replacement', cost: 20, labor: 0.5, category: 'both' },
            recharge: { title: 'Refrigerant Recharge (lb)', cost: 35, labor: 0.5, category: 'both' },
            leakSearch: { title: 'Leak Search', cost: 10, labor: 1.5, category: 'residential' },
            coilClean: { title: 'Chem Clean Coils', cost: 25, labor: 1.0, category: 'both' },
            blowerMotor: { title: 'Blower Motor', cost: 150, labor: 2.0, category: 'both' },
            condenserMotor: { title: 'Condenser Fan Motor', cost: 120, labor: 1.5, category: 'both' },
            ignitor: { title: 'Hot Surface Ignitor', cost: 40, labor: 0.5, category: 'residential' },
            flameSensor: { title: 'Flame Sensor Clean/Repl', cost: 15, labor: 0.5, category: 'residential' },
            drainClear: { title: 'Clear Drain Line', cost: 5, labor: 1.0, category: 'both' }
        };

        // State
        let app, auth, db, userId;
        let units = [];
        let activeUnitId = null;
        let customLineItems = []; 
        let inventory = []; 
        let customerDB = {}; 
        let quickJobs = {}; 
        
        // Track manual labor override
        let manualLaborSet = false;

        // Init
        try {
            app = initializeApp(FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, (user) => {
                document.getElementById('loading-indicator').classList.add('hidden');
                if (user) { userId = user.uid; handleLoginUI(user); loadInventory(); } 
                else { userId = null; handleLogoutUI(); }
            });
        } catch (e) { console.error("Firebase Error", e); }

        function initApp() {
            loadServiceData(); 
            renderServiceChecklists('residential');
            loadCachedCustomers();
            if(units.length === 0) addUnit(); 

            // Events
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                    e.target.classList.add('tab-active');
                    renderServiceChecklists(e.target.dataset.tab);
                });
            });

            document.getElementById('addUnitBtn').addEventListener('click', addUnit);
            document.getElementById('removeUnitBtn').addEventListener('click', removeActiveUnit);
            document.getElementById('addCustomLineItemBtn').addEventListener('click', addCustomItemFromInput);
            document.getElementById('addInventoryItemBtn').addEventListener('click', addInventoryItem);
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
            document.getElementById('csvInput').addEventListener('change', handleCsvUpload);
            document.getElementById('customerName').addEventListener('input', autofillCustomer);
            
            // Listeners for calc
            document.getElementById('laborRate').addEventListener('input', calculateTotals);
            document.getElementById('tripCharge').addEventListener('input', calculateTotals);
            document.getElementById('marginPercent').addEventListener('input', calculateTotals);
            
            // Special handling for Labor Hours input to track manual override
            document.getElementById('laborHours').addEventListener('input', (e) => {
                manualLaborSet = true;
                calculateTotals();
            });

            document.getElementById('google-sign-in').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
            document.getElementById('google-sign-out').addEventListener('click', () => signOut(auth));
            document.getElementById('saveCloudBtn').addEventListener('click', saveToCloud);
            document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
        }

        // --- SERVICE DATA ---
        function loadServiceData() {
            const stored = localStorage.getItem('hvac_services_db');
            quickJobs = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(DEFAULT_JOBS));
        }
        window.saveCustomServices = () => {
            const rows = document.querySelectorAll('#serviceManagerBody tr');
            const newJobs = {};
            rows.forEach(row => {
                const key = row.dataset.key;
                const cat = row.querySelector('.sm-cat').value;
                const name = row.querySelector('.sm-name').value;
                const cost = parseFloat(row.querySelector('.sm-cost').value) || 0;
                const labor = parseFloat(row.querySelector('.sm-labor').value) || 0;
                if(name) newJobs[key] = { title: name, cost, labor, category: cat };
            });
            quickJobs = newJobs;
            localStorage.setItem('hvac_services_db', JSON.stringify(quickJobs));
            toggleServiceModal();
            const activeTab = document.querySelector('.tab-btn.tab-active');
            renderServiceChecklists(activeTab ? activeTab.dataset.tab : 'residential');
            calculateTotals();
        }
        window.resetDefaultServices = () => {
            if(confirm("Reset to defaults?")) {
                quickJobs = JSON.parse(JSON.stringify(DEFAULT_JOBS));
                localStorage.setItem('hvac_services_db', JSON.stringify(quickJobs));
                renderServiceManager();
            }
        }
        window.toggleServiceModal = () => {
            const modal = document.getElementById('serviceManagerModal');
            modal.classList.toggle('opacity-0'); modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
            if(!modal.classList.contains('opacity-0')) renderServiceManager();
        }
        function renderServiceManager() {
            const tbody = document.getElementById('serviceManagerBody');
            tbody.innerHTML = '';
            Object.keys(quickJobs).forEach(key => addServiceManagerRow(key, quickJobs[key]));
        }
        function addServiceManagerRow(key, item) {
            const tbody = document.getElementById('serviceManagerBody');
            const tr = document.createElement('tr');
            tr.dataset.key = key; tr.className = "border-b hover:bg-gray-50";
            tr.innerHTML = `
                <td class="p-2"><select class="sm-cat border rounded p-1 text-xs"><option value="residential" ${item.category === 'residential'?'selected':''}>Res</option><option value="commercial" ${item.category === 'commercial'?'selected':''}>Comm</option><option value="both" ${item.category === 'both'?'selected':''}>Both</option></select></td>
                <td class="p-2"><input type="text" class="sm-name border rounded p-1 w-full" value="${item.title}"></td>
                <td class="p-2"><input type="number" class="sm-cost border rounded p-1 w-full" value="${item.cost}"></td>
                <td class="p-2"><input type="number" class="sm-labor border rounded p-1 w-full" value="${item.labor}"></td>
                <td class="p-2 text-center"><button onclick="this.closest('tr').remove()" class="text-red-500 hover:text-red-700"><i class="fa fa-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        }
        window.addNewServiceRow = () => addServiceManagerRow('custom_'+Date.now(), {title:'', cost:0, labor:0, category:'both'});

        // --- CSV ---
        function handleCsvUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    const uniqueCount = processCsvData(results.data);
                    showMessage(`Imported ${uniqueCount} unique customers.`, "bg-green-100 text-green-700");
                    document.getElementById('csv-status').textContent = `DB: ${uniqueCount} Customers loaded`;
                },
                error: function(err) { alert("Error parsing CSV: " + err.message); }
            });
        }
        function processCsvData(rows) {
            let uniqueCount = 0;
            rows.forEach(row => {
                const name = row['Customer'];
                if (name) {
                    if(!customerDB[name]) uniqueCount++;
                    customerDB[name] = {
                        address: row['Service Address'] || '',
                        contact: row['Bill To'] || '',
                        type: (row['Location Type'] || '').toLowerCase().includes('commercial') ? 'commercial' : 'residential'
                    };
                }
            });
            localStorage.setItem('hvac_customer_db', JSON.stringify(customerDB));
            populateCustomerList();
            return Object.keys(customerDB).length;
        }
        function loadCachedCustomers() {
            const cached = localStorage.getItem('hvac_customer_db');
            if (cached) {
                try {
                    customerDB = JSON.parse(cached);
                    const count = Object.keys(customerDB).length;
                    if (count > 0) {
                        document.getElementById('csv-status').textContent = `DB: ${count} Cached Customers`;
                        populateCustomerList();
                    }
                } catch (e) { console.error("Cache error", e); }
            }
        }
        function populateCustomerList() {
            const datalist = document.getElementById('customerOptions');
            datalist.innerHTML = '';
            Object.keys(customerDB).sort().forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                datalist.appendChild(opt);
            });
        }
        function autofillCustomer(e) {
            const val = e.target.value;
            const data = customerDB[val];
            if (data) {
                document.getElementById('customerAddress').value = data.address;
                document.getElementById('customerContact').value = data.contact;
                if (data.type) document.querySelectorAll('.tab-btn').forEach(btn => { if (btn.dataset.tab === data.type) btn.click(); });
                showMessage("Customer details autofilled!", "bg-blue-100 text-blue-700");
            }
        }

        // --- UNITS ---
        function createUnit(id) { return { id, name: `Unit ${units.length + 1}`, brand: '', model: '', serial: '', notes: '', photos: [], selectedServices: new Set() }; }
        function addUnit() { const id = Date.now(); units.push(createUnit(id)); setActiveUnit(id); }
        function removeActiveUnit() { if(units.length <= 1) return alert("Keep at least one unit."); units = units.filter(u => u.id !== activeUnitId); setActiveUnit(units[0].id); }
        function setActiveUnit(id) { activeUnitId = id; renderUnitTabs(); renderUnitDetails(); updateCheckboxes(); }
        function renderUnitTabs() {
            const container = document.getElementById('unitTabs'); container.innerHTML = '';
            units.forEach(u => {
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 text-sm font-medium rounded-t-lg border-t border-l border-r ${u.id === activeUnitId ? 'unit-tab-active' : 'bg-gray-100 hover:bg-gray-200'}`;
                btn.textContent = u.name;
                btn.onclick = () => setActiveUnit(u.id);
                container.appendChild(btn);
            });
        }
        function renderUnitDetails() {
            const u = units.find(unit => unit.id === activeUnitId);
            const container = document.getElementById('unitDetailsContainer');
            if(!u) return;

            let brandSelectOptions = `<option value="" disabled ${!u.brand ? 'selected' : ''}>-- Select Brand --</option>`;
            brandOptions.forEach(b => { brandSelectOptions += `<option value="${b}" ${u.brand === b ? 'selected' : ''}>${b}</option>`; });
            const isCustomBrand = u.brand && !brandOptions.includes(u.brand);
            const showCustomInput = u.brand === 'Other' || isCustomBrand;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <input type="text" value="${u.name}" class="input-field" oninput="updateUnit('${u.id}', 'name', this.value)" placeholder="Unit Name (e.g. RTU-1)">
                    <div>
                        <select class="input-field" id="brandSelect-${u.id}" onchange="handleBrandChange('${u.id}', this.value)">${brandSelectOptions}</select>
                        <input type="text" id="brandCustom-${u.id}" value="${isCustomBrand ? u.brand : ''}" class="input-field mt-2 ${showCustomInput ? '' : 'hidden'}" placeholder="Enter Custom Brand" oninput="updateUnit('${u.id}', 'brand', this.value)">
                    </div>
                    <input type="text" value="${u.model}" class="input-field" oninput="updateUnit('${u.id}', 'model', this.value)" placeholder="Model #">
                    <input type="text" value="${u.serial}" class="input-field" oninput="updateUnit('${u.id}', 'serial', this.value)" placeholder="Serial #">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Diagnosis / Service Notes</label>
                    <textarea class="input-field w-full min-h-[200px] resize-y text-base p-4 border-gray-400 bg-yellow-50 focus:bg-white" placeholder="Type detailed diagnosis here..." oninput="updateUnit('${u.id}', 'notes', this.value)">${u.notes}</textarea>
                </div>
                <div class="flex flex-wrap gap-2 mb-2" id="photoGallery-${u.id}">
                    ${u.photos.map((src, idx) => `<div class="relative w-20 h-20"><img src="${src}" class="w-full h-full object-cover rounded border shadow"><button onclick="removePhoto('${u.id}', ${idx})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hover:bg-red-700">&times;</button></div>`).join('')}
                </div>
                <button onclick="document.getElementById('photoInput').click()" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200"><i class="fa fa-camera mr-1"></i> Add Photo</button>
            `;
        }
        window.handleBrandChange = (id, val) => {
            const customInput = document.getElementById(`brandCustom-${id}`);
            if(val === 'Other') { customInput.classList.remove('hidden'); customInput.focus(); updateUnit(id, 'brand', ''); } 
            else { customInput.classList.add('hidden'); updateUnit(id, 'brand', val); }
        };
        window.updateUnit = (id, field, val) => { const u = units.find(unit => unit.id === id); if(u) { u[field] = val; if(field === 'name') renderUnitTabs(); } }

        // --- CHECKLIST UI ---
        function renderServiceChecklists(type) {
            const container = document.getElementById('serviceListContainer'); container.innerHTML = '';
            Object.keys(quickJobs).forEach(key => {
                const item = quickJobs[key];
                if(item.category === 'both' || item.category === type) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-2 hover:bg-gray-50 rounded';
                    div.innerHTML = `<input type="checkbox" id="cb-${key}" data-key="${key}" class="service-cb w-4 h-4 text-blue-600 rounded"><label for="cb-${key}" class="ml-2 text-sm text-gray-700 w-full cursor-pointer select-none">${item.title}</label>`;
                    container.appendChild(div);
                }
            });
            document.querySelectorAll('.service-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const u = units.find(unit => unit.id === activeUnitId);
                    if(u) { e.target.checked ? u.selectedServices.add(e.target.dataset.key) : u.selectedServices.delete(e.target.dataset.key); calculateTotals(); }
                });
            });
            updateCheckboxes();
        }
        function updateCheckboxes() { const u = units.find(unit => unit.id === activeUnitId); document.querySelectorAll('.service-cb').forEach(cb => cb.checked = u && u.selectedServices.has(cb.dataset.key)); }

        // --- INVENTORY & TOTALS ---
        function loadInventory() {
            if(!userId) return;
            const ref = collection(db, `artifacts/${FIREBASE_CONFIG.appId}/users/${userId}/hvac_inventory`);
            onSnapshot(ref, (snap) => {
                inventory = []; const select = document.getElementById('inventory-selector');
                select.innerHTML = '<option value="" disabled selected>-- Quick Add from Inventory --</option>';
                snap.forEach(doc => { const d = doc.data(); inventory.push({id:doc.id, ...d}); const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = `${d.name} ($${d.cost})`; select.appendChild(opt); });
            });
        }
        function addInventoryItem() { const id = document.getElementById('inventory-selector').value; const item = inventory.find(i => i.id === id); if(item) addCustomLineItem(item.name, item.cost, 1); }
        function addCustomItemFromInput() { const name = document.getElementById('customPartName').value; const cost = parseFloat(document.getElementById('customPartCost').value)||0; const qty = parseFloat(document.getElementById('customPartQty').value)||1; if(name) { addCustomLineItem(name, cost, qty); document.getElementById('customPartName').value = ''; } }
        function addCustomLineItem(description, cost, qty) { customLineItems.push({ id: Date.now(), description, cost, qty, unitId: activeUnitId }); calculateTotals(); }
        window.removeLineItem = (id) => { customLineItems = customLineItems.filter(i => i.id !== id); calculateTotals(); }
        
        // --- MATH LOGIC ---
        function calculateTotals() {
            let partsTotal = 0; 
            let laborHrsTotal = 0; 
            const tbody = document.getElementById('combinedLineItemsBody'); 
            tbody.innerHTML = '';
            
            const renderHeader = (name) => {
                tbody.innerHTML += `<tr class="bg-gray-200"><td colspan="4" class="px-4 py-2 font-bold text-gray-700 uppercase text-xs">${name}</td></tr>`;
            };

            units.forEach(u => {
                let unitPartsCost = 0;
                let unitItemsCount = 0;
                const unitItemsHTML = [];

                // Checklists
                u.selectedServices.forEach(key => {
                    const job = quickJobs[key];
                    if(job) {
                        const cost = Number(job.cost) || 0;
                        const labor = Number(job.labor) || 0;
                        unitPartsCost += cost;
                        partsTotal += cost; 
                        laborHrsTotal += labor;
                        unitItemsCount++;
                        unitItemsHTML.push(`<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2 text-sm text-gray-700 pl-8">${job.title}</td><td class="px-4 py-2 text-right text-sm text-gray-600">$${cost.toFixed(2)}</td><td class="px-4 py-2 text-right text-sm text-gray-600">1</td><td class="px-4 py-2 text-center text-xs text-gray-400">Fixed</td></tr>`);
                    }
                });

                // Custom Items
                customLineItems.filter(i => i.unitId === u.id).forEach(item => {
                    const cost = Number(item.cost) || 0;
                    const qty = Number(item.quantity) || 1;
                    const total = cost * qty;
                    unitPartsCost += total;
                    partsTotal += total;
                    unitItemsCount++;
                    unitItemsHTML.push(`<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2 text-sm text-gray-700 pl-8">${item.description}</td><td class="px-4 py-2 text-right text-sm text-gray-600">$${cost.toFixed(2)}</td><td class="px-4 py-2 text-right text-sm text-gray-600">${qty}</td><td class="px-4 py-2 text-center"><button onclick="removeLineItem(${item.id})" class="text-red-500 hover:text-red-700"><i class="fa fa-trash"></i></button></td></tr>`);
                });

                if(unitItemsCount > 0) {
                    renderHeader(`${u.name} ${u.brand ? '('+u.brand+')' : ''}`);
                    tbody.innerHTML += unitItemsHTML.join('');
                    // Unit Subtotal Row
                    tbody.innerHTML += `<tr class="bg-blue-50 border-b"><td class="px-4 py-1 text-xs text-right font-bold text-gray-600" colspan="2">Parts Subtotal: $${unitPartsCost.toFixed(2)}</td><td colspan="2"></td></tr>`;
                }
            });
            
            // Handle General/Unassigned
            const activeUnitIds = units.map(u => u.id);
            const orphanedItems = customLineItems.filter(i => !activeUnitIds.includes(i.unitId));
            if(orphanedItems.length > 0) {
                renderHeader("General / Unassigned");
                orphanedItems.forEach(item => {
                    const cost = Number(item.cost) || 0;
                    const qty = Number(item.quantity) || 1;
                    partsTotal += (cost * qty);
                    tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2 text-sm text-gray-700 pl-8">${item.description}</td><td class="px-4 py-2 text-right text-sm text-gray-600">$${cost.toFixed(2)}</td><td class="px-4 py-2 text-right text-sm text-gray-600">${qty}</td><td class="px-4 py-2 text-center"><button onclick="removeLineItem(${item.id})" class="text-red-500 hover:text-red-700"><i class="fa fa-trash"></i></button></td></tr>`;
                });
            }

            // Labor Handling
            const laborInput = document.getElementById('laborHours');
            let finalLaborHrs = 0;
            if (manualLaborSet) {
                finalLaborHrs = Number(laborInput.value) || 0;
            } else {
                finalLaborHrs = laborHrsTotal;
                laborInput.value = finalLaborHrs.toFixed(1); // Auto-update value
            }

            const rate = Number(document.getElementById('laborRate').value) || 0;
            const trip = Number(document.getElementById('tripCharge').value) || 0;
            
            const laborCost = finalLaborHrs * rate;
            const subtotal = partsTotal + laborCost + trip;
            
            const marginInput = document.getElementById('marginPercent').value;
            const margin = Number(marginInput) || 0;
            
            let price = subtotal;
            if(margin > 0 && margin < 100) {
                price = subtotal / (1 - (margin/100));
            }
            
            const profit = price - subtotal;

            document.getElementById('totalParts').textContent = `$${partsTotal.toFixed(2)}`;
            document.getElementById('totalLabor').textContent = `$${laborCost.toFixed(2)}`;
            document.getElementById('subtotalCost').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('profitDisplay').textContent = `Profit: $${profit.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `$${price.toFixed(2)}`;
        }

        // --- AUTH/PDF ---
        function handleLoginUI(user) { document.getElementById('google-sign-in').classList.add('hidden'); document.getElementById('user-panel').classList.remove('hidden'); document.getElementById('user-email').textContent = user.email; document.getElementById('saveCloudBtn').classList.remove('hidden'); document.getElementById('connection-status').textContent = "● Database Connected"; }
        function handleLogoutUI() { document.getElementById('google-sign-in').classList.remove('hidden'); document.getElementById('user-panel').classList.add('hidden'); document.getElementById('saveCloudBtn').classList.add('hidden'); document.getElementById('connection-status').textContent = "○ Local Mode Only"; }
        
        async function saveToCloud() {
            if(!userId) return alert("Sign in first."); const name = document.getElementById('customerName').value; if(!name) return alert("Customer Name Required");
            const data = { customer: { name, contact: document.getElementById('customerContact').value, address: document.getElementById('customerAddress').value, workOrder: document.getElementById('workOrderNo').value }, units: units.map(u => ({...u, selectedServices: Array.from(u.selectedServices)})), customLineItems, financials: { laborRate: document.getElementById('laborRate').value, trip: document.getElementById('tripCharge').value, margin: document.getElementById('marginPercent').value, total: document.getElementById('grandTotal').textContent }, timestamp: serverTimestamp() };
            try { await setDoc(doc(collection(db, `artifacts/${FIREBASE_CONFIG.appId}/users/${userId}/hvac_estimates`)), data); showMessage("Estimate Saved!", "bg-green-100 text-green-700"); } catch(e) { console.error(e); alert("Error saving."); }
        }
        
        function handlePhotoUpload(e) { const u = units.find(unit => unit.id === activeUnitId); if(!u || !e.target.files[0]) return; const reader = new FileReader(); reader.onload = (ev) => { u.photos.push(ev.target.result); renderUnitDetails(); }; reader.readAsDataURL(e.target.files[0]); }
        window.removePhoto = (uId, idx) => { const u = units.find(unit => unit.id == uId); if(u) { u.photos.splice(idx, 1); renderUnitDetails(); } }
        function showMessage(msg, classes) { const box = document.getElementById('message-box'); box.textContent = msg; box.className = `p-4 rounded-lg text-sm mb-6 transition-opacity duration-300 font-semibold text-center ${classes}`; box.classList.remove('hidden'); setTimeout(() => box.classList.add('hidden'), 3000); }
        
        async function generatePDF() {
            const doc = new jsPDF(); const margin = 15; let y = 20;
            doc.setFontSize(22).setTextColor(40).text("HVAC Service Report", margin, y); y += 10;
            doc.setFontSize(10).setTextColor(100).text("Mechanical Temp Service", margin, y);
            const wo = document.getElementById('workOrderNo').value; if(wo) doc.text(`Work Order #: ${wo}`, 150, y); y += 15;
            doc.setDrawColor(200); doc.line(margin, y, 195, y); y += 10;
            doc.setFontSize(12).setTextColor(0).text("Customer:", margin, y); doc.setFontSize(10); y += 6;
            doc.text(`Name: ${document.getElementById('customerName').value}`, margin, y); y += 5;
            doc.text(`Address: ${document.getElementById('customerAddress').value}`, margin, y); y += 10;
            units.forEach(u => {
                if(y > 250) { doc.addPage(); y = 20; }
                doc.setFontSize(14).setFont(undefined, 'bold').text(`${u.name} (${u.brand || 'N/A'})`, margin, y); y += 7;
                doc.setFontSize(10).setFont(undefined, 'normal');
                if(u.notes) { const splitNotes = doc.splitTextToSize(`Notes: ${u.notes}`, 170); doc.text(splitNotes, margin, y); y += (splitNotes.length * 5) + 5; }
                u.selectedServices.forEach(key => { const job = quickJobs[key]; if(job) { doc.text(`[x] ${job.title}`, margin + 5, y); y += 5; } });
                customLineItems.filter(i => i.unitId === u.id).forEach(i => { doc.text(`- ${i.description} (Qty: ${i.quantity})`, margin + 5, y); y += 5; });
                y += 10;
            });
            y = 250; doc.line(margin, y, 195, y); y += 10; doc.setFontSize(14).setFont(undefined, 'bold');
            if(document.getElementById('pdfOption').value === 'flatRate') { doc.text(`Total Investment: ${document.getElementById('grandTotal').textContent}`, margin, y); }
            else { doc.setFontSize(10); doc.text(`Parts: ${document.getElementById('totalParts').textContent}`, margin, y); y+=5; doc.text(`Labor: ${document.getElementById('totalLabor').textContent}`, margin, y); y+=5; doc.setFontSize(14); doc.text(`Total: ${document.getElementById('grandTotal').textContent}`, margin, y+5); }
            doc.save('Service_Report.pdf');
        }

        initApp();
    </script>
</body>
</html>
